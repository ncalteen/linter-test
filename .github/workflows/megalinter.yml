name: MegaLinter

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  checks: write
  contents: write
  issues: write
  packages: read
  pull-requests: write
  statuses: write

env:
  APPLY_FIXES: all
  APPLY_FIXES_EVENT: pull_request
  APPLY_FIXES_MODE: pull_request

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint Codebase
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Lint Codebase
        id: lint-codebase
        env:
          GITHUB_TOKEN: ${{ github.token }}
        uses: oxsecurity/megalinter@v8.1.0

      - if: ${{ always() }}
        name: Upload MegaLinter Artifacts
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: MegaLinter Reports
          path: |
            megalinter-reports
            mega-linter.log

      - if: ${{ always() }}
        run: |
          echo "${{ github.head_ref }}"
          echo "${{ github.ref }}"
          echo "${{ steps.lint-codebase.outputs }}"

      - if: |
          always() &&
          steps.lint-codebase.outputs.has_updated_sources == 1
        name: Create Pull Request with Fixes
        id: pull-request
        uses: peter-evans/create-pull-request@v7
        with:
          branch: ${{ github.head_ref || github.ref }}-megalinter-fixes
          commit-message:
            '[MegaLinter] (${{ github.head_ref || github.ref }}) Automatic Fixes'
          title:
            '[MegaLinter] (${{ github.head_ref || github.ref }}) Automatic Fixes'
          body:
            This PR was automatically generated by MegaLinter. It contains fixes
            for file(s) that did not pass the linter checks. Please review the
            changes and merge if they are correct.
